# 智能人脉管理工具 - MVP 产品需求文档 v4

## 一、应用概述与核心价值

这是一款面向个人或商务人士的智能人脉管理工具，采用“AI增强，人工确认”的设计理念。用户通过自然语言（打字）输入关于某个人的信息，大模型自动提取并分类，最终形成结构化的人物档案、关系网络和圈子视图。应用强调用户审查与干预，确保AI辅助的准确性，同时尊重用户的自定义调整。

### 核心价值

- **极简录入**：用日常对话更新人脉档案。
- **智能结构化**：自动提取关键信息（个人信息、事件、未来约定、资源方向）。
- **可视化洞察**：通过关系网络图和圈子泡泡图，直观发现核心人脉和社交圈层。
- **用户掌控**：所有AI生成内容需经用户确认，冲突和歧义由用户裁决，用户编辑过的字段永不被AI覆盖。

---

## 二、核心数据模型

### 2.1 人物 (Person)

- `id`：唯一标识
- `name`：姓名（唯一约束，不允许重名）
- `avatar`：头像路径（可选）
- `profile_json`：存储档案信息，包括：
  - `job`：职业（字符串类型，当前职业；职业历史可通过事件记录）
  - `birthday`：生日（格式可为 MM-DD 或 YYYY-MM-DD，年份未知时用 xxxx 占位，如 xxxx-05-20）
- `age`：年龄（根据生日计算，如果信息不足(如为 xxxx时)则显示未知）
- `events`：事件列表（按时间排序，每个事件包含 date、location、description）
- 其他自定义字段（如简介、公司等）
- `created_at`，`updated_at`

> 说明：`birthday` 字段允许后续补充年份，存储格式保留原始精度。年龄自动计算，若年份未知则不计算。

### 2.2 关系 (Relation)

- `id`
- `from_person_id`
- `to_person_id`
- `relation_type`：关系类型（如"朋友"、"同事"）
- `confirmed_by_user`：是否经历用户确认（所有保存的关系均视为用户确认）
- `created_at`

> 重要：关系默认视为双向。保存 from-to 关系时，系统自动创建或更新 to-from 的同类型关系，确保双方一致。对于不对称关系（如"上级"），可在后续版本细化，MVP阶段统一双向处理。

### 2.3 标注 (Annotation)

- `id`
- `person_id`：关联人物
- `time`：具体日期或时间段（格式 YYYY-MM-DD 或 YYYY-MM，若为相对时间如"下个月"则根据输入时的当前时间转换为 YYYY-MM，表示整个月）
- `location`：地点
- `description`：关键动作（如"出差"）
- `confirmed_by_user`
- `created_at`

> 说明：相对时间转换规则：基于用户输入时的系统时间计算。例如"下个月" → 当前月份 +1，格式为 YYYY-MM；"下周" → 当前周 +1，转换为该周起始日或直接存储为 YYYY-MM-DD（取具体日期，但前端可显示为"下周"）。若当前是12月，则转换为下一年1月。MVP统一采用具体日期或年月，以简化存储。

### 2.4 发展方向 (Development)

- `id`
- `person_id`
- `content`：描述（如"AI"、"芯片"）
- `type`：类型（如"resource"）
- `confirmed_by_user`
- `created_at`

### 2.5 圈子 (Circle)

- `id`
- `name`：圈子名称
- `color`：莫兰迪色值
- `created_at`

> 说明：圈子只由用户手动创建或从自动生成中确认后创建，无 assigned_by_user 字段，创建即视为用户所有。

### 2.6 人物-圈子关联 (PersonCircle)

- `person_id`
- `circle_id`
- `assigned_by_user`：始终为 true（圈子分配只由用户确认后生效）

### 2.7 来源标记

每个子条目（事件、标注、发展方向等）需存储 source 字段，枚举值：

- `user`：用户手动编辑或确认过的（永久有效，AI永不覆盖）
- `ai_suggested`：AI提取但尚未确认（仅用于预览，保存后转为 user）
- `ai_confirmed`：曾由AI提取且用户确认（与 user 合并，确认后即视为用户数据）

> 人物本身的属性（如 job、birthday）不单独标记来源，通过冲突解决流程确认后即视为用户数据。

---

## 三、全流程详细步骤

### 3.1 首页：信息输入与AI提取

1. 在首页文本框输入一段关于某人的描述，点击提交。
2. 系统将文本发送至后端 POST /extract 接口。
3. 后端调用大模型，通过函数调用强制输出以下JSON结构：

```json
{
  "profile": {
    "name": "张三",
    "job": "AI工程师",
    "birthday": "05-20",
    "events": [
      { "date": "2025-03-15", "description": "一起吃饭", "location": "北京" }
    ]
  },
  "annotations": [
    { "time": "2025-04-01", "location": "上海", "description": "出差" }
  ],
  "developments": [
    { "content": "AI芯片", "type": "resource" }
  ],
  "relations": [
    { "name": "李四", "relation_type": "同事" }
  ]
}
```

### 3.2 同名检测与分支处理

后端收到AI提取的JSON后，根据 profile.name 查询数据库：

- 若姓名不存在：进入新建流程，跳转到确认界面（3.3）。
- 若姓名已存在：进入同名消歧步骤。弹出模态框，让用户选择：
  - **这是同一个人**：选项A：完善说明：点击后，系统将本次AI提取的内容（除姓名外）与现有档案对比，仅显示新增或冲突的部分，并进入确认界面（见3.3）。用户可在确认界面修改这些新增项。
  - **这是另一个人**：选项B：新建，但需修改姓名（系统可自动添加数字后缀，如"张三(2)"），用户也可手动改名。

### 3.3 确认界面（预览与编辑）

#### 布局：

- 顶部显示原始输入文本。
- 下方分三栏展示提取内容，每栏中的每条均可编辑：
  - 档案栏：姓名、职业、生日、事件列表。
  - 标注栏：未来标注（时间、地点、描述）。
  - 发展方向栏：内容、类型。
- 单独区域显示检测到的人物关系列表（例如"与李四（同事）"），可修改关系类型或删除。
- 若存在冲突（见3.4），在关系区域下方弹出冲突提示框，列出所有冲突项并提供解决选项。

#### 编辑功能：

- 每条提取项旁有编辑图标或内嵌编辑框，用户可点击修改内容。
- 删除按钮独立存在，用于删除整条提取项。
- 每个栏目下方提供"添加"按钮，可手动新增条目。

#### 事件展示规则：

- 同一天的事件合并为一个时间模块。（要进行事件相似度比较，以详细版本为主。如同一天内，原已记录"和B吃饭"，现想添加"和B吃午饭"则显示现在的新增，并且保存后取代原记录，反之则不显示）
- 视觉上：绿色小模块显示时间（如"3月15日"），蓝色小模块显示地点（可选），同一行后面用黑色文字显示事件描述。
- 同一天的不同事件分行展示，每个事件独立一行（时间模块和地点模块复用，描述换行）。

### 3.4 冲突检测与解决

#### 冲突类型：

1. **信息冲突**（仅针对人物属性字段，如生日、职业）：
   - 例如数据库已有生日"05-21"，AI提取为"05-20"。
   - 解决：在冲突提示框中列出，让用户选择保留原值、保留新值、或手动输入新值。

2. **事件列表合并**：
   - AI提取的新事件直接作为新增项展示，不与现有事件进行冲突判断。用户可在确认界面手动删除重复项或修改描述。

3. **关系双向不一致**（理论上不会发生，因为系统自动维护双向，但若用户手动修改单向关系可能产生）：
   - 解决：提示用户选择保持单向或强制双向。

> 用户必须解决所有冲突后才能点击“保存”按钮。

### 3.5 保存与更新

- 用户点击“保存”后，前端将最终确认的数据发送至后端 POST /confirm。
- 后端以原子操作合并更新数据库：
  - 对于完善模式，将新增项添加到对应人物列表中，冲突项以用户选择为准。
  - 关系表：根据用户确认的关系创建/更新，并自动补全反向关系。
  - 所有保存的条目来源标记为 user。
- 更新成功后，前端刷新可视化视图。

---

## 四、可视化与交互

### 4.1 人物档案页

- 点击人物头像或从列表进入。
- 顶部：姓名、头像上传、简介。
- 下方标签页：
  - **档案**：个人信息、事件时间线（按日期排序，展示格式同确认界面）、未来标注列表、发展方向列表。所有字段可点击直接修改，编辑后立即生效并标记为 user。
  - **关系**：以迷你关系图或列表展示与该人物直接相连的其他人物及关系。可在此处添加/编辑关系。

### 4.2 关系网络图（第二页模式一）

力导向图，节点为人名，节点大小正比于连接数。

连线标注关系类型。

对于关系中不存在的人物，默认不创建该人物，并触发提示“人物未创建”（如用户在A的档案中写B是A的朋友，但是此时B未创建，则触发“B未创建”提示）

交互：

- 悬停显示人物卡片（姓名、头像、简介）。
- 双击节点进入人物档案页。
- 支持拖拽节点，手动整理布局。
- 布局保存：用户调整后的节点坐标会保存到后端（每个用户一份），下次进入时恢复。

### 4.3 圈子分类图（第二页模式二）

#### 4.3.1 圈子基本操作

- **创建**：点击“新建圈子”，输入名称、选择莫兰迪色。
- **分配人物**：
  - 手动拖拽：将人物头像拖入某个泡泡。
  - 基于发展方向：在人物档案页，若人物有发展方向，旁边显示“加入[领域]圈子”按钮（前提是存在同名圈子），点击加入。
  - 批量分配：在人物列表页按发展方向筛选，批量选择人物并分配到指定圈子。
- **可视化**：
  - 每个圈子显示为彩色泡泡，大小正比于圈内人数。
  - 圈内人物以小头像悬浮在泡泡上。
  - 泡泡间有简单碰撞检测，可拖拽调整布局。

#### 4.3.2 圈子自动分类功能

- **触发**：圈子管理页面增加“自动生成圈子”按钮。
- **算法**：
  1. 遍历所有人物的发展方向内容（development.content）。
  2. 精确匹配分组，相同字符串归为一类。
  3. 需要引入简单的语义相似度，如AI和人工智能未同类，以字符少的优先显示（若相同则以出现时间晚的）。
  4. 每类生成一个建议圈子：名称取该发展方向内容，颜色随机从莫兰迪色系选取，人物为所有拥有该发展方向的人。
- **预览与确认**：
  - 弹出模态框，以卡片形式列出每个圈子。
  - 每个卡片可编辑名称、颜色、人物列表（勾选/取消），可删除整个圈子。
  - 用户修改后点击“确认保存”，正式创建圈子；若名称与已有圈子重复，提示合并或重命名。
- **注意**：自动生成的圈子不会覆盖已有圈子，且人物可属于多个圈子。

---

## 五、技术实现要点

### 5.1 前端

- 框架：React + TypeScript
- 状态管理：Zustand
- UI库：AntDesign 或 Material-UI
- 可视化：
  - 关系网络：Cytoscape.js（轻量、支持力导向）
  - 圈子泡泡：Canvas + d3-force 模拟布局
- 本地存储：IndexedDB（用于网络中断时暂存确认数据）
- 布局保存：定期将力导向图书点坐标上传至后端。

### 5.2 后端

- 语言：Python + FastAPI
- 大模型集成：
  - 使用用户已有的API（英伟达的免费api，可调用 z-ai/glm4.7等国内模型），通过函数调用强制输出指定JSON。
  - 超时设置10秒，失败时提示用户重试。
  - 输入文本长度限制2000字符。
- 数据验证：Pydantic 模型校验。
- API 端点：
  - POST /extract：接收文本，返回提取 JSON
  - POST /confirm：接收确认数据，更新数据库
  - GET /persons、GET /graph、GET /circles 等查询接口
  - POST /graph/layout：保存关系图布局坐标

### 5.3 数据库

- SQLite，文件存储于 ./data/app.db
- 使用 SQLAlchemy ORM
- 布局存储表（示例）：
```sql
CREATE TABLE graph_layout (
  user_id TEXT PRIMARY KEY,
  layout_json TEXT,
  updated_at DATETIME
);
```

### 5.4 安全加固

- 前端渲染 React 默认转义，防 XSS
- 后端输入校验、长度限制
- 错误信息不暴露敏感细节
- 环境变量管理 API 密钥
- 提供数据导出（JSON/CSV）和删除功能

---

## 六、颜色要求

界面主色调、关系图连线、圈子泡泡等均使用莫兰迪色系。建议色值（可扩展）：

- #4A7B9C（灰蓝）
- #9B6B6B（豆沙）
- #5F7256（苔绿）
- #B5A189（卡其）
- #9251A8（紫灰）
- #F7F6F1（米白）

---

## 七、补充说明

- 人物上限：30人，确保界面流畅。
- 输入方式：仅文本输入，暂不支持语音、图片、文档。
- 数据备份：提醒用户定期备份SQLite文件。
- 错误恢复：网络中断时，前端将确认数据暂存IndexedDB，待网络恢复后自动重试。
- UI设计：现代柔和高雅风格，如用圆角矩形等。
